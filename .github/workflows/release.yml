# .github/workflows/release.yml
# Copyright (C) 2025 Pedro Henrique / phkaiser13
#
# SPDX-License-Identifier: Apache-2.0
#
# Este workflow é responsável por criar uma release no GitHub.
# Ele é acionado após a conclusão bem-sucedida dos workflows de build
# e empacota os artefatos de cada plataforma em um formato de distribuição.

name: 'Criação de Release'

on:
  workflow_run:
    # Aciona este workflow quando os workflows de build listados terminam na branch main
    workflows:
      - "Build do gitph (Ubuntu/Debian-Like linux Systems)"
      - "Build gitph (Fedora-like Linux)"
      - "Build gitph (Arch-like - containerized)"
      - "Build gitph (Windows)"
      - "Build gitph (macOS & Darwin systems)"
    types:
      - completed
    branches:
      - main

jobs:
  release:
    name: 'Criar Release e Empacotar Artefatos'
    # Executa apenas se o workflow acionador foi bem-sucedido e se for um push (não em PRs)
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write # Permissão necessária para criar a release

    steps:
      - name: '1. Checkout do código'
        uses: actions/checkout@v4

      - name: '2. Extrair versão do CMakeLists.txt'
        id: get_version
        run: |
          # Extrai a versão do projeto do arquivo CMakeLists.txt para nomear a tag da release
          VERSION=$(grep -oP 'project\(gitph VERSION \K[0-9.]+' CMakeLists.txt)
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Tag da Release: v${VERSION}"

      - name: '3. Baixar todos os artefatos dos builds'
        uses: actions/download-artifact@v4
        with:
          # Associa os artefatos ao workflow que acionou este
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          # O download-artifact criará diretórios com os nomes dos artefatos
          # Ex: ./gitph-build-artifacts-arch/, ./gitph-build-artifacts-ubuntu-x86_64/, etc.

      - name: '4. Organizar e empacotar artefatos'
        run: |
          # Cria o diretório de releases
          mkdir -p release_packages

          # Função para criar o pacote tar.gz
          create_package() {
            local ARTIFACT_DIR=$1
            local PLATFORM_NAME=$2
            local VERSION=$3
            local RELEASE_NAME="gitph-v${VERSION}-${PLATFORM_NAME}"
            
            echo "Empacotando o conteúdo de '${ARTIFACT_DIR}' em '${RELEASE_NAME}.tar.gz'"
            
            if [ ! -d "${ARTIFACT_DIR}" ]; then
              echo "Aviso: Diretório do artefato '${ARTIFACT_DIR}' não encontrado. Pulando."
              return
            fi

            # Empacota o conteúdo do diretório, não o diretório em si, usando -C
            tar -czf "release_packages/${RELEASE_NAME}.tar.gz" -C "${ARTIFACT_DIR}" .
          }
          
          # Itera sobre todos os diretórios de artefatos baixados
          for dir in *-build-artifacts*; do
            if [ -d "$dir" ]; then
                # Extrai o nome da plataforma do nome do diretório do artefato
                platform_name=$(echo "$dir" | sed -e 's/gitph-build-artifacts-//' -e 's/build-artifacts-//')
                # Lida com o caso do Windows que tem um subdiretório 'Release'
                if [[ "$platform_name" == "windows"* && -d "$dir/Release" ]]; then
                    create_package "$dir/Release" "$platform_name" "${{ env.VERSION }}"
                else
                    create_package "$dir" "$platform_name" "${{ env.VERSION }}"
                fi
            fi
          done

          echo "Pacotes de release prontos:"
          ls -l release_packages

      - name: '5. Criar Release e Anexar Pacotes'
        uses: softprops/action-gh-release@v2
        with:
          # Usa a versão extraída como nome da tag
          tag_name: "v${{ env.VERSION }}"
          # Anexa todos os pacotes .tar.gz criados
          files: release_packages/*.tar.gz
          # Gera o corpo da release automaticamente com base nos commits
          generate_release_notes: true
