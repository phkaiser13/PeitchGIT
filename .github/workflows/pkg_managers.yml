name: Release -> Render & Publish Packaging

# Trigger on published releases
on:
  release:
    types: [published]

permissions:
  contents: write   # allow commits/pushes (for the repo where this workflow lives)

env:
  # Target repositories (change to your actual repositories if different)
  HOME_TAP_REPO: "phkaiser13/homebrew-tap"
  VCPKG_REPO: "phkaiser13/vcpkg-registry"
  AUR_PACKAGES_REPO: "phkaiser13/aur-packages"

  # Templates for EXTERNAL repositories (inside THIS repository)
  TEMPLATE_HOMEBREW: "./templates/homebrew/phgit.rb.template"
  TEMPLATE_VCPKG_PORTFILE: "./templates/vcpkg/portfile.cmake.template"
  TEMPLATE_VCPKG_JSON: "./templates/vcpkg/vcpkg.json.template"
  TEMPLATE_AUR_PKGBUILD: "./templates/aur/PKGBUILD.template"

  # Templates for THIS repository (shared/template -> packaging/)
  SHARED_TEMPLATES_DIR: "./shared/template"

jobs:
  render-and-push:
    runs-on: ubuntu-latest
    env:
      # Allow user to override PAT secrets names; if not set we'll fallback to GITHUB_TOKEN where possible.
      HOME_TAP_PAT_SECRET_NAME: HOME_TAP_PAT
      VCPKG_PAT_SECRET_NAME: VCPKG_PAT
      AUR_PACKAGES_PAT_SECRET_NAME: AUR_PACKAGES_PAT
    steps:

      - name: Checkout current repository (templates & workspace)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine release version (strip leading 'v')
        id: version
        run: |
          set -euo pipefail
          echo "GITHUB_REF_NAME = ${{ github.ref_name }}"
          RAW="${{ github.ref_name }}"
          if [[ -z "$RAW" ]]; then
            echo "ERROR: workflow must run from a release tag (GITHUB_REF_NAME empty)."
            exit 1
          fi
          VERSION="${RAW#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Download source tarball and compute checksums
        id: checksums
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"
          TAR_URL="https://github.com/phkaiser13/peitchgit/archive/refs/tags/v${VERSION}.tar.gz"
          echo "Tarball URL: ${TAR_URL}"
          TMP="$(mktemp)"
          curl -L --fail -sS "${TAR_URL}" -o "${TMP}"
          # SHA256 & SHA512
          if command -v sha256sum >/dev/null 2>&1; then
            TARBALL_SHA256="$(sha256sum "${TMP}" | awk '{print $1}')"
            TARBALL_SHA512="$(sha512sum "${TMP}" | awk '{print $1}')"
          else
            TARBALL_SHA256="$(shasum -a 256 "${TMP}" | awk '{print $1}')"
            TARBALL_SHA512="$(shasum -a 512 "${TMP}" | awk '{print $1}')"
          fi
          echo "Computed tarball SHA256: ${TARBALL_SHA256}"
          echo "Computed tarball SHA512: ${TARBALL_SHA512}"
          # export
          echo "phgit_tarb_sha256=${TARBALL_SHA256}" >> $GITHUB_OUTPUT
          echo "phgit_tarb_sha512=${TARBALL_SHA512}" >> $GITHUB_OUTPUT
          # keep tmp path in env in case other steps want to reuse
          echo "TARBALL_PATH=${TMP}" >> $GITHUB_ENV

      - name: Try to download Windows installer asset and compute installer sha256 (optional)
        id: installer
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"
          INSTALLER_NAME="phgit-${VERSION}-installer.exe"
          INSTALLER_URL="https://github.com/phkaiser13/peitchgit/releases/download/v${VERSION}/${INSTALLER_NAME}"
          echo "Attempting to download installer: ${INSTALLER_URL}"
          TMP_INSTALLER="$(mktemp)"
          if curl -L --fail -sS "${INSTALLER_URL}" -o "${TMP_INSTALLER}"; then
            if command -v sha256sum >/dev/null 2>&1; then
              INSTALLER_SHA256="$(sha256sum "${TMP_INSTALLER}" | awk '{print $1}')"
            else
              INSTALLER_SHA256="$(shasum -a 256 "${TMP_INSTALLER}" | awk '{print $1}')"
            fi
            echo "Installer found. SHA256: ${INSTALLER_SHA256}"
            echo "installer_sha256=${INSTALLER_SHA256}" >> $GITHUB_OUTPUT
            echo "INSTALLER_PATH=${TMP_INSTALLER}" >> $GITHUB_ENV
          else
            echo "Installer not found at ${INSTALLER_URL} -- skipping installer checksum."
            echo "installer_sha256=" >> $GITHUB_OUTPUT
          fi

      - name: Render shared templates into packaging/ (THIS repository)
        id: render-local
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"
          TARBALL_SHA256="${{ steps.checksums.outputs.phgit_tarb_sha256 }}"
          TARBALL_SHA512="${{ steps.checksums.outputs.phgit_tarb_sha512 }}"
          INSTALLER_SHA256="${{ steps.installer.outputs.installer_sha256 }}"
          TAR_URL="https://github.com/phkaiser13/peitchgit/archive/refs/tags/v${VERSION}.tar.gz"
          TODAY="$(date -R)"

          echo "🔄 Rendering shared templates into packaging/ ..."

          # Create all packaging directories
          mkdir -p packaging/chocolatey/tools
          mkdir -p packaging/rpm
          mkdir -p packaging/debian
          mkdir -p packaging/snap

          # === CHOCOLATEY ===
          # Render Chocolatey nuspec
          if [[ -f "${{ env.SHARED_TEMPLATES_DIR }}/phgit.nuspec.template" ]]; then
            sed -e "s/@PHGIT_VERSION@/${VERSION}/g" \
                "${{ env.SHARED_TEMPLATES_DIR }}/phgit.nuspec.template" > packaging/chocolatey/phgit.nuspec
            echo "✅ Rendered packaging/chocolatey/phgit.nuspec"
          fi

          # Render Chocolatey install script
          if [[ -f "${{ env.SHARED_TEMPLATES_DIR }}/chocolateyinstall.ps1.template" ]]; then
            sed -e "s/@PHGIT_VERSION@/${VERSION}/g" \
                -e "s/@PHGIT_INSTALLER_SHA256@/${INSTALLER_SHA256}/g" \
                "${{ env.SHARED_TEMPLATES_DIR }}/chocolateyinstall.ps1.template" > packaging/chocolatey/tools/chocolateyinstall.ps1
            echo "✅ Rendered packaging/chocolatey/tools/chocolateyinstall.ps1"
          fi

          # === RPM ===
          # Render RPM spec
          if [[ -f "${{ env.SHARED_TEMPLATES_DIR }}/phgit.spec.template" ]]; then
            sed -e "s/@PHGIT_VERSION@/${VERSION}/g" \
                -e "s,@PHGIT_TARBALL_URL@,${TAR_URL},g" \
                -e "s/@PHGIT_RELEASE_DATE@/${TODAY}/g" \
                "${{ env.SHARED_TEMPLATES_DIR }}/phgit.spec.template" > packaging/rpm/phgit.spec
            echo "✅ Rendered packaging/rpm/phgit.spec"
          fi

          # === DEBIAN ===
          # Render Debian control
          if [[ -f "${{ env.SHARED_TEMPLATES_DIR }}/debian/control.template" ]]; then
            cp "${{ env.SHARED_TEMPLATES_DIR }}/debian/control.template" packaging/debian/control
            echo "✅ Rendered packaging/debian/control"
          fi

          # Render Debian postrm
          if [[ -f "${{ env.SHARED_TEMPLATES_DIR }}/debian/postrm.template" ]]; then
            cp "${{ env.SHARED_TEMPLATES_DIR }}/debian/postrm.template" packaging/debian/postrm
            chmod +x packaging/debian/postrm
            echo "✅ Rendered packaging/debian/postrm"
          fi

          # Render Debian rules
          if [[ -f "${{ env.SHARED_TEMPLATES_DIR }}/debian/rules.template" ]]; then
            cp "${{ env.SHARED_TEMPLATES_DIR }}/debian/rules.template" packaging/debian/rules
            chmod +x packaging/debian/rules
            echo "✅ Rendered packaging/debian/rules"
          fi

          # Render Debian changelog
          if [[ -f "${{ env.SHARED_TEMPLATES_DIR }}/debian/changelog.template" ]]; then
            sed -e "s/@PHGIT_VERSION@/${VERSION}/g" \
                -e "s/@PHGIT_RELEASE_DATE@/${TODAY}/g" \
                "${{ env.SHARED_TEMPLATES_DIR }}/debian/changelog.template" > packaging/debian/changelog
            echo "✅ Rendered packaging/debian/changelog"
          fi

          # === SNAP ===
          # Render Snap snapcraft.yaml
          if [[ -f "${{ env.SHARED_TEMPLATES_DIR }}/snap/snapcraft.yaml.template" ]]; then
            sed -e "s/@PHGIT_VERSION@/${VERSION}/g" \
                "${{ env.SHARED_TEMPLATES_DIR }}/snap/snapcraft.yaml.template" > packaging/snap/snapcraft.yaml
            echo "✅ Rendered packaging/snap/snapcraft.yaml"
          fi

          echo "🎯 All shared templates rendered successfully!"

      - name: Commit shared-template renders to THIS repository
        id: commit-local
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packaging || true
          if git diff --staged --quiet; then
            echo "ℹ️ No changes to commit in packaging/"
          else
            git commit -m "chore(release): render packaging templates for phgit ${{ steps.version.outputs.version }}"
            git push origin HEAD
            echo "✅ Committed packaging files to repository"
          fi

      # ---------------------------
      # Update homebrew-tap repository
      # ---------------------------
      - name: Checkout homebrew-tap repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.HOME_TAP_REPO }}
          token: ${{ secrets.HOME_TAP_PAT || github.token }}
          path: homebrew-tap
          fetch-depth: 0

      - name: Render and place Homebrew formula
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"
          TARBALL_SHA256="${{ steps.checksums.outputs.phgit_tarb_sha256 }}"
          TEMPLATE="${{ env.TEMPLATE_HOMEBREW }}"
          
          if [[ ! -f "${TEMPLATE}" ]]; then
            echo "❌ ERROR: Homebrew template not found at ${TEMPLATE}"
            exit 1
          fi
          
          mkdir -p homebrew-tap/Formula
          sed -e "s/@PHGIT_VERSION@/${VERSION}/g" \
              -e "s/@PHGIT_SHA256@/${TARBALL_SHA256}/g" \
              "${TEMPLATE}" > homebrew-tap/Formula/phgit.rb
          echo "✅ Rendered homebrew-tap/Formula/phgit.rb"

      - name: Commit & push Homebrew formula
        run: |
          set -euo pipefail
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/phgit.rb
          if git diff --staged --quiet; then
            echo "ℹ️ No changes to commit in homebrew-tap."
          else
            git commit -m "chore(release): update phgit formula to ${{ steps.version.outputs.version }}"
            git push origin HEAD
            echo "🍺 Updated Homebrew formula"
          fi

      # ---------------------------
      # Update vcpkg-registry repository
      # ---------------------------
      - name: Checkout vcpkg-registry repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.VCPKG_REPO }}
          token: ${{ secrets.VCPKG_PAT || github.token }}
          path: vcpkg-registry
          fetch-depth: 0

      - name: Render and place vcpkg port files
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"
          TARBALL_SHA512="${{ steps.checksums.outputs.phgit_tarb_sha512 }}"
          
          mkdir -p vcpkg-registry/ports/phgit

          # Render portfile.cmake
          if [[ ! -f "${{ env.TEMPLATE_VCPKG_PORTFILE }}" ]]; then
            echo "❌ ERROR: vcpkg portfile template missing: ${{ env.TEMPLATE_VCPKG_PORTFILE }}"
            exit 1
          fi
          sed -e "s/@PHGIT_VERSION@/${VERSION}/g" \
              -e "s/@PHGIT_SHA512@/${TARBALL_SHA512}/g" \
              "${{ env.TEMPLATE_VCPKG_PORTFILE }}" > vcpkg-registry/ports/phgit/portfile.cmake
          echo "✅ Rendered portfile.cmake"

          # Render vcpkg.json
          if [[ -f "${{ env.TEMPLATE_VCPKG_JSON }}" ]]; then
            sed -e "s/@PHGIT_VERSION@/${VERSION}/g" \
                "${{ env.TEMPLATE_VCPKG_JSON }}" > vcpkg-registry/ports/phgit/vcpkg.json
            echo "✅ Rendered vcpkg.json"
          fi

      - name: Commit & push vcpkg-registry
        run: |
          set -euo pipefail
          cd vcpkg-registry
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ports/phgit || true
          if git diff --staged --quiet; then
            echo "ℹ️ No changes to commit in vcpkg-registry."
          else
            git commit -m "chore(release): update vcpkg port for phgit ${{ steps.version.outputs.version }}"
            git push origin HEAD
            echo "📦 Updated vcpkg registry"
          fi

      # ---------------------------
      # Update aur-packages repository
      # ---------------------------
      - name: Checkout aur-packages repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.AUR_PACKAGES_REPO }}
          token: ${{ secrets.AUR_PACKAGES_PAT || github.token }}
          path: aur-packages
          fetch-depth: 0

      - name: Render and place PKGBUILD
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"
          TARBALL_SHA256="${{ steps.checksums.outputs.phgit_tarb_sha256 }}"
          TEMPLATE="${{ env.TEMPLATE_AUR_PKGBUILD }}"
          
          if [[ ! -f "${TEMPLATE}" ]]; then
            echo "❌ ERROR: AUR PKGBUILD template not found at ${TEMPLATE}"
            exit 1
          fi
          
          mkdir -p aur-packages/phgit
          sed -e "s/@PHGIT_VERSION@/${VERSION}/g" \
              -e "s/@PHGIT_SHA256@/${TARBALL_SHA256}/g" \
              "${TEMPLATE}" > aur-packages/phgit/PKGBUILD
          echo "✅ Rendered aur-packages/phgit/PKGBUILD"

      - name: Generate .SRCINFO for PKGBUILD (optional)
        run: |
          set -euo pipefail
          if command -v docker >/dev/null 2>&1; then
            echo "🐳 Generating .SRCINFO with Docker..."
            mkdir -p /tmp/pkgbdir
            cp aur-packages/phgit/PKGBUILD /tmp/pkgbdir/PKGBUILD
            docker run --rm -v /tmp/pkgbdir:/work -w /work archlinux:latest bash -lc "
              pacman -Sy --noconfirm --needed base-devel >/dev/null 2>&1 || true
              makepkg --printsrcinfo > .SRCINFO
            " && mv /tmp/pkgbdir/.SRCINFO aur-packages/phgit/.SRCINFO
            echo "✅ Generated .SRCINFO"
          else
            echo "⚠️ Docker not available — skipping .SRCINFO generation"
          fi

      - name: Commit & push aur-packages
        run: |
          set -euo pipefail
          cd aur-packages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add phgit || true
          if git diff --staged --quiet; then
            echo "ℹ️ No changes to commit in aur-packages."
          else
            git commit -m "chore(release): update PKGBUILD for phgit ${{ steps.version.outputs.version }}"
            git push origin HEAD
            echo "🏛️ Updated AUR package"
          fi

      - name: Summary
        run: |
          set -euo pipefail
          echo "🎉 Release packaging completed for phgit ${{ steps.version.outputs.version }}"
          echo ""
          echo "📊 Checksums:"
          echo "  📄 Tarball SHA256: ${{ steps.checksums.outputs.phgit_tarb_sha256 }}"
          echo "  📄 Tarball SHA512: ${{ steps.checksums.outputs.phgit_tarb_sha512 }}"
          if [[ -n "${{ steps.installer.outputs.installer_sha256 }}" ]]; then
            echo "  🪟 Installer SHA256: ${{ steps.installer.outputs.installer_sha256 }}"
          else
            echo "  🪟 Installer: Not found (skipped)"
          fi
          echo ""
          echo "📦 Updated repositories:"
          echo "  🍺 ${{ env.HOME_TAP_REPO }} (Homebrew)"
          echo "  📚 ${{ env.VCPKG_REPO }} (vcpkg)"
          echo "  🏛️ ${{ env.AUR_PACKAGES_REPO }} (AUR)"
          echo "  📁 phkaiser13/peitchgit (packaging/)"
          echo ""
          echo "✨ All package managers updated successfully!"