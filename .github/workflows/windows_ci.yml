name: Build para Windows

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-windows:
    name: Build em Windows (MSVC)
    runs-on: windows-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@v2

      # Instalar vcpkg manualmente para controle total
      - name: Instalar vcpkg e dependências
        shell: powershell
        run: |
          if (-Not (Test-Path C:/vcpkg/vcpkg.exe)) {
            git clone https://github.com/microsoft/vcpkg.git C:/vcpkg
            C:/vcpkg/bootstrap-vcpkg.bat
          }
          C:/vcpkg/vcpkg.exe install curl:x64-windows lua:x64-windows nlohmann-json:x64-windows
          C:/vcpkg/vcpkg.exe integrate install

      - name: Listar pacotes vcpkg instalados
        shell: powershell
        run: C:/vcpkg/vcpkg.exe list

      - name: Configurar CMake com toolchain do vcpkg
        shell: powershell
        run: cmake -S . -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows

      - name: Compilar Projeto
        run: cmake --build build --config Release --parallel
